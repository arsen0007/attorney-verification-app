<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attorney Verification Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .log-container { height: 300px; }
        .table-container { max-height: 500px; }
        #file-drop-zone.dragover { border-color: #2563eb; background-color: #eff6ff; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-full">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900">Attorney Verification Tool</h1>
            <p class="text-slate-500 mt-2">Upload a CSV to verify attorney status on the CalBar website.</p>
        </header>

        <main class="space-y-8">
            <!-- Top Section: Controls & Log -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-semibold mb-4 text-slate-900">1. Upload & Run</h2>
                    <div id="file-drop-zone" class="p-6 text-center rounded-lg cursor-pointer border-2 border-dashed border-slate-300 transition">
                        <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                        <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                        <p id="file-name-display" class="mt-2 text-sm text-slate-600"><span class="font-semibold text-blue-600">Click to upload</span> or drag & drop CSV.</p>
                    </div>
                    <div class="mt-6 flex space-x-4">
                        <button id="start-btn" class="flex-1 bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-sm hover:bg-blue-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors" disabled>Start Verification</button>
                        <button id="stop-btn" class="flex-1 bg-red-600 text-white font-semibold py-3 rounded-lg shadow-sm hover:bg-red-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors" disabled>Stop Process</button>
                    </div>
                    <div class="mt-6">
                        <div class="w-full bg-slate-200 rounded-full h-2.5"><div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        <p id="progress-text" class="text-center text-sm text-slate-500 mt-2">Waiting to start...</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-xl font-semibold mb-2 text-slate-900">Activity Log</h3>
                    <div id="log-container" class="log-container custom-scrollbar bg-slate-100 p-4 rounded-lg border border-slate-200 text-sm font-mono overflow-y-auto">
                        <p class="text-slate-500">Log messages will appear here...</p>
                    </div>
                </div>
            </div>

            <!-- Bottom Section: Results -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-slate-900">2. View Results</h2>
                    <button id="download-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-green-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors" disabled>Download Results CSV</button>
                </div>
                <div class="table-container custom-scrollbar overflow-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
                            <tr>
                                <th scope="col" class="px-3 py-3">Name</th>
                                <th scope="col" class="px-3 py-3">Status</th>
                                <th scope="col" class="px-3 py-3">Discipline</th>
                                <th scope="col" class="px-3 py-3">Email Exact</th>
                                <th scope="col" class="px-3 py-3">Lastname in Email</th>
                                <th scope="col" class="px-3 py-3">Firstname in Email</th>
                                <th scope="col" class="px-3 py-3">Lastname in Website</th>
                                <th scope="col" class="px-3 py-3">Firstname in Website</th>
                                <th scope="col" class="px-3 py-3">Profile Link</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                           <tr class="border-b border-slate-200"><td colspan="9" class="px-4 py-8 text-center text-slate-500">Results will be displayed here.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const fileInput = document.getElementById('csv-file-input'), fileDropZone = document.getElementById('file-drop-zone'),
              fileNameDisplay = document.getElementById('file-name-display'), startBtn = document.getElementById('start-btn'),
              stopBtn = document.getElementById('stop-btn'), downloadBtn = document.getElementById('download-btn'),
              progressBar = document.getElementById('progress-bar'), progressText = document.getElementById('progress-text'),
              logContainer = document.getElementById('log-container'), resultsTableBody = document.getElementById('results-table-body');
        let statusInterval;

        fileDropZone.addEventListener('click', () => fileInput.click());
        fileDropZone.addEventListener('dragover', (e) => { e.preventDefault(); fileDropZone.classList.add('dragover'); });
        fileDropZone.addEventListener('dragleave', () => fileDropZone.classList.remove('dragover'));
        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', () => { if (fileInput.files.length) handleFile(fileInput.files[0]); });

        function handleFile(file) {
            if (file && file.name.endsWith('.csv')) {
                fileNameDisplay.innerHTML = `<span class="font-semibold text-slate-800">${file.name}</span>`;
                startBtn.disabled = false;
            } else {
                fileNameDisplay.innerHTML = `<span class="font-semibold text-red-600">Invalid file. Please select a .csv file.</span>`;
                startBtn.disabled = true;
            }
        }

        startBtn.addEventListener('click', async () => {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            const response = await fetch('/start', { method: 'POST', body: formData });
            if (response.ok) {
                setUiRunningState(true);
                statusInterval = setInterval(getStatus, 1500);
            } else { alert(`Error: ${(await response.json()).error}`); }
        });

        stopBtn.addEventListener('click', () => fetch('/stop', { method: 'POST' }));

        async function getStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                updateUI(data);
                if (!data.is_running && statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                    setUiRunningState(false);
                }
            } catch (e) {
                logMessage("Error connecting to server. Stopping.", 'error');
                if (statusInterval) clearInterval(statusInterval);
                setUiRunningState(false);
            }
        }
        
        function setUiRunningState(isRunning) {
            startBtn.disabled = isRunning;
            stopBtn.disabled = !isRunning;
            fileInput.disabled = isRunning;
            downloadBtn.disabled = isRunning || resultsTableBody.children.length === 0;
        }
        
        let lastLogLength = 0;
        function updateUI(status) {
            const percent = status.total > 0 ? (status.progress / status.total) * 100 : 0;
            progressBar.style.width = `${percent}%`;
            progressText.textContent = status.is_running ? `Processing ${status.progress} of ${status.total}...` : `Process Finished.`;

            if (status.log.length > lastLogLength) {
                if (lastLogLength === 0) logContainer.innerHTML = '';
                status.log.slice(lastLogLength).forEach(msg => logMessage(msg));
                lastLogLength = status.log.length;
            }

            resultsTableBody.innerHTML = '';
            if (status.results.length === 0) {
                 resultsTableBody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-slate-500">No results yet.</td></tr>';
            } else {
                status.results.forEach(res => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-200 bg-white hover:bg-slate-50';
                    row.innerHTML = `
                        <td class="px-3 py-2 font-medium">${res.Name}</td>
                        <td class="px-3 py-2">${renderStatus(res['Verified Status'])}</td>
                        <td class="px-3 py-2">${renderConfidence(res['Discipline Found'], 'Yes', 'text-red-600 font-bold')}</td>
                        <td class="px-3 py-2">${renderConfidence(res['Email Matched (Exact)'])}</td>
                        <td class="px-3 py-2">${renderConfidence(res['Lastname in Email'])}</td>
                        <td class="px-3 py-2">${renderConfidence(res['Firstname in Email'])}</td>
                        <td class="px-3 py-2">${renderConfidence(res['Lastname in Website'])}</td>
                        <td class="px-3 py-2">${renderConfidence(res['Firstname in Website'])}</td>
                        <td class="px-3 py-2">${renderLink(res['Profile Link'])}</td>
                    `;
                    resultsTableBody.appendChild(row);
                });
                downloadBtn.disabled = false;
            }
        }
        
        function logMessage(message) {
             const p = document.createElement('p');
             if(message.includes('ERROR') || message.includes('failed')) p.className = 'text-red-500';
             else if(message.includes('Match FOUND')) p.className = 'text-green-600';
             else p.className = 'text-slate-600';
             p.textContent = message;
             logContainer.appendChild(p);
             logContainer.scrollTop = logContainer.scrollHeight;
        }

        function renderStatus(status) {
            if (status.toLowerCase().includes('active')) return `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${status}</span>`;
            if (status.toLowerCase().includes('not found') || status.toLowerCase().includes('error')) return `<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${status}</span>`;
            return `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${status}</span>`;
        }
        
        function renderConfidence(text, highlight = 'Yes', style = 'text-green-600 font-semibold') {
            return text === highlight ? `<span class="${style}">${text}</span>` : text;
        }
        
        function renderLink(link) {
            return link.startsWith('http') ? `<a href="${link}" target="_blank" class="text-blue-600 hover:underline">View Profile</a>` : 'N/A';
        }

        downloadBtn.addEventListener('click', async () => {
            const response = await fetch('/status');
            const data = await response.json();
            const headers = Object.keys(data.results[0]);
            let csvContent = headers.join(",") + "\n";
            data.results.forEach(row => {
                const values = headers.map(header => {
                    let cell = (row[header] || '').toString().replace(/"/g, '""');
                    return cell.includes(',') ? `"${cell}"` : cell;
                });
                csvContent += values.join(",") + "\n";
            });

            const link = document.createElement("a");
            link.setAttribute("href", 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            link.setAttribute("download", "Verification_Results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>
</html>
